<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Persons - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-dark: #005f73;
            --primary-orange: #ee9b00;
            --light-bg: #f5f7fb;
            --dark-text: #333333;
            --danger: #dc3545;
        }
        body { background-color: var(--light-bg); }
        .navbar-dark.bg-dark { background: linear-gradient(135deg, var(--primary-dark) 0%, #0a9396 100%) !important; }
        .sidebar { background: white; min-height: 100vh; box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05); }
        .sidebar .nav-link { color: var(--dark-text); }
        .sidebar .nav-link.active, .sidebar .nav-link:hover { background-color: rgba(0, 95, 115, 0.1); color: var(--primary-dark); }
        .card { border: none; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('admin') }}"><i class="fas fa-seedling me-2"></i>Admin Dashboard</a>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-lg-2 col-md-3 d-none d-md-block sidebar p-3">
                <ul class="nav flex-column">
                    <li class="nav-item"><a class="nav-link {% if active_page == 'dashboard' %}active{% endif %}" href="{{ url_for('admin') }}"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link {% if active_page == 'orders' %}active{% endif %}" href="{{ url_for('admin_orders') }}"><i class="fas fa-shopping-cart"></i> Orders</a></li>
                    <li class="nav-item"><a class="nav-link {% if active_page == 'products' %}active{% endif %}" href="{{ url_for('admin_products') }}"><i class="fas fa-box"></i> Products</a></li>
                    <li class="nav-item"><a class="nav-link {% if active_page == 'users' %}active{% endif %}" href="{{ url_for('admin_users') }}"><i class="fas fa-users"></i> Users</a></li>
                    <li class="nav-item"><a class="nav-link {% if active_page == 'delivery_persons' %}active{% endif %}" href="{{ url_for('admin_delivery_persons') }}"><i class="fas fa-motorcycle"></i> Delivery Persons</a></li>
                    <li class="nav-item"><a class="nav-link {% if active_page == 'analytics' %}active{% endif %}" href="{{ url_for('admin_analytics') }}"><i class="fas fa-chart-bar"></i> Analytics</a></li>
                    <li class="nav-item"><a class="nav-link {% if active_page == 'payouts' %}active{% endif %}" href="{{ url_for('admin_payouts') }}"><i class="fas fa-hand-holding-usd"></i> Payouts</a></li>
                    <li class="nav-item"><a class="nav-link {% if active_page == 'categories' %}active{% endif %}" href="{{ url_for('admin_categories') }}"><i class="fas fa-tags"></i> Categories</a></li>
                    <li class="nav-item"><a class="nav-link {% if active_page == 'reviews' %}active{% endif %}" href="{{ url_for('admin_reviews') }}"><i class="fas fa-star"></i> Reviews</a></li>
                </ul>
            </nav>

            <!-- Main Content -->
            <main class="col-lg-10 col-md-9 ms-sm-auto px-4 py-3">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3 mb-0">Delivery Persons</h1>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#personModal" onclick="openAddModal()">
                        <i class="fas fa-plus me-2"></i>Add New Person
                    </button>
                </div>

                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th>Name</th>
                                        <th>Contact</th>
                                        <th>Vehicle</th>
                                        <th>Vehicle No.</th>
                                        <th>License No.</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="persons-table-body">
                                    {% for person in persons %}
                                    <tr id="person-row-{{ person.id }}">
                                        <td>
                                            <img src="{{ url_for('static', filename=person.profile_picture) if person.profile_picture else 'https://via.placeholder.com/40' }}" class="rounded-circle me-2" style="width: 40px; height: 40px; object-fit: cover;" alt="{{ person.name }}">
                                            <span>{{ person.name }}</span>
                                        </td>
                                        <td>{{ person.phone }}</td>
                                        <td>{{ person.vehicle_type }}</td>
                                        <td>{{ person.vehicle_number }}</td>
                                        <td>{{ person.license_number }}</td>
                                        <td>
                                            <span class="badge {{ 'bg-success' if person.is_active else 'bg-secondary' }}">
                                                {{ 'Active' if person.is_active else 'Inactive' }}
                                            </span>
                                        </td>
                                        <td>
                                            <a href="{{ url_for('delivery_person_details', person_id=person.id) }}" class="btn btn-sm btn-outline-info"><i class="fas fa-eye"></i></a>
                                            <button class="btn btn-sm btn-outline-secondary edit-btn" data-id="{{ person.id }}"><i class="fas fa-edit"></i></button>
                                            <button class="btn btn-sm btn-outline-danger delete-btn" data-id="{{ person.id }}" data-name="{{ person.name }}"><i class="fas fa-trash"></i></button>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="7" class="text-center py-5 text-muted">No delivery persons found.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add/Edit Person Modal -->
    <div class="modal fade" id="personModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="personForm" enctype="multipart/form-data">
                    <div class="moda
                        <h5 class="modal-title" id="personModalLabel">Add Delivery Person</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="personId" name="id">
                        <div class="mb-3">
                            <label for="name" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="phone" name="phone" required>
                        </div>
                        <div class="mb-3">
                            <label for="address" class="form-label">Address</label>
                            <textarea class="form-control" id="address" name="address" rows="2"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="vehicle_type" class="form-label">Vehicle Type</label>
                                <input type="text" class="form-control" id="vehicle_type" name="vehicle_type" value="Bike">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="vehicle_number" class="form-label">Vehicle Number</label>
                                <input type="text" class="form-control" id="vehicle_number" name="vehicle_number" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="license_number" class="form-label">License Number</label>
                            <input type="text" class="form-control" id="license_number" name="license_number" required>
                        </div>
                        <div class="mb-3">
                            <label for="profile_picture" class="form-label">Profile Picture</label>
                            <input type="file" class="form-control" id="profile_picture" name="profile_picture" accept="image/*">
                            <div id="profile_picture_preview" class="mt-2"></div>
                        </div>
                        <div class="mb-3">
                            <label for="license_image" class="form-label">License Image</label>
                            <input type="file" class="form-control" id="license_image" name="license_image" accept="image/*">
                            <div id="license_image_preview" class="mt-2"></div>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="is_active" name="is_active" checked>
                            <label class="form-check-label" for="is_active">Is Active</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const personModal = new bootstrap.Modal(document.getElementById('personModal'));
            const form = document.getElementById('personForm');

            window.openAddModal = function() {
                form.reset();
                document.getElementById('personId').value = '';
                document.getElementById('personModalLabel').textContent = 'Add Delivery Person';
                document.getElementById('is_active').checked = true;
                document.getElementById('profile_picture_preview').innerHTML = '';
                document.getElementById('license_image_preview').innerHTML = '';
            }

            document.getElementById('persons-table-body').addEventListener('click', function(e) {
                if (e.target.closest('.edit-btn')) {
                    const id = e.target.closest('.edit-btn').dataset.id;
                    fetch(`/admin/delivery_person/${id}`)
                        .then(res => res.json())
                        .then(data => {
                            document.getElementById('personId').value = data.id;
                            document.getElementById('name').value = data.name;
                            document.getElementById('phone').value = data.phone;
                            document.getElementById('address').value = data.address;
                            document.getElementById('vehicle_type').value = data.vehicle_type;
                            document.getElementById('vehicle_number').value = data.vehicle_number;
                            document.getElementById('license_number').value = data.license_number;
                            document.getElementById('is_active').checked = data.is_active;

                            const profilePreview = document.getElementById('profile_picture_preview');
                            profilePreview.innerHTML = '';
                            if (data.profile_picture) {
                                profilePreview.innerHTML = `<img src="/static/${data.profile_picture}" class="img-thumbnail mt-2" width="100"> <small class="text-muted d-block">Current Picture</small>`;
                            }

                            const licensePreview = document.getElementById('license_image_preview');
                            licensePreview.innerHTML = '';
                            if (data.license_image) {
                                licensePreview.innerHTML = `<img src="/static/${data.license_image}" class="img-thumbnail mt-2" width="100"> <small class="text-muted d-block">Current License</small>`;
                            }

                            document.getElementById('personModalLabel').textContent = 'Edit Delivery Person';
                            personModal.show();
                        });
                }

                if (e.target.closest('.delete-btn')) {
                    const id = e.target.closest('.delete-btn').dataset.id;
                    const name = e.target.closest('.delete-btn').dataset.name;
                    if (confirm(`Are you sure you want to delete ${name}?`)) {
                        fetch(`/admin/delivery_person/delete/${id}`, { method: 'POST' })
                            .then(res => res.json())
                            .then(data => {
                                if (data.success) {
                                    alert(data.message);
                                    location.reload();
                                } else {
                                    alert('Error: ' + data.error);
                                }
                            });
                    }
                }
            });

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const id = document.getElementById('personId').value;
                const url = id ? `/admin/delivery_person/edit/${id}` : '/admin/delivery_person/add';
                const formElement = document.getElementById('personForm');
                const formData = new FormData(formElement);

                fetch(url, {
                    method: 'POST',
                    body: formData
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        personModal.hide();
                        alert(data.message);
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                });
            });
        });
    </script>
</body>
</html>